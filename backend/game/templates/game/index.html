{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>县令模拟器</title>
  <link rel="stylesheet" href="{% static 'game/css/main.css' %}">
</head>
<body>

<!-- ==================== Screen 1: Login ==================== -->
<section id="screen-login" class="screen active">
  <div class="login-box">
    <h1>县令模拟器</h1>
    <p class="subtitle">治一方水土，安一方百姓</p>
    <form id="login-form">
      <input type="text" id="login-username" placeholder="用户名" required autocomplete="username">
      <input type="password" id="login-password" placeholder="密码" required autocomplete="current-password">
      <button type="submit" class="btn btn-primary">登录</button>
      <p id="login-error" class="error-msg hidden"></p>
    </form>
    <p class="hint">账号请通过管理后台创建</p>
  </div>
</section>

<!-- ==================== Screen 2: Game List ==================== -->
<section id="screen-game-list" class="screen hidden">
  <div class="top-bar">
    <h2>我的游戏</h2>
    <div class="top-bar-right">
      <span id="username-display"></span>
      <button id="btn-logout" class="btn btn-small">登出</button>
    </div>
  </div>

  <div class="new-game-panel">
    <h3>开始新游戏</h3>
    <p>选择出身背景：</p>
    <div class="background-choices">
      <button class="btn btn-background" data-bg="HUMBLE">
        <strong>寒门子弟</strong>
        <span>知识3 / 技能3</span>
      </button>
      <button class="btn btn-background" data-bg="SCHOLAR">
        <strong>书香门第</strong>
        <span>知识5 / 技能3</span>
      </button>
      <button class="btn btn-background" data-bg="OFFICIAL">
        <strong>官宦之后</strong>
        <span>知识4 / 技能5</span>
      </button>
    </div>
  </div>

  <div id="game-list-container">
    <h3>已有存档</h3>
    <div id="game-list"></div>
  </div>
</section>

<!-- ==================== Screen 3: Game Play ==================== -->
<section id="screen-game" class="screen hidden">
  <!-- Header -->
  <div class="game-header">
    <button id="btn-back-to-list" class="btn btn-small">返回列表</button>
    <div class="header-info">
      <span id="season-display"></span>
      <span id="treasury-display"></span>
    </div>
  </div>

  <!-- Tab Navigation -->
  <nav class="tab-nav">
    <button class="tab-btn active" data-tab="tab-dashboard">县情总览</button>
    <button class="tab-btn" data-tab="tab-villages">村庄</button>
    <button class="tab-btn" data-tab="tab-actions">施政</button>
    <button class="tab-btn" data-tab="tab-report">月报</button>
    <button class="tab-btn" data-tab="tab-relationships">人脉</button>
    <button class="tab-btn" data-tab="tab-staff">幕僚</button>
    <button class="tab-btn" data-tab="tab-neighbors">邻县</button>
    <button class="tab-btn" data-tab="tab-events">县志</button>
  </nav>

  <!-- Tab: Dashboard -->
  <div id="tab-dashboard" class="tab-content active">
    <div id="negotiation-banner" class="negotiation-banner hidden"></div>
    <div id="stats-grid" class="stats-grid"></div>
    <div id="info-row" class="info-row"></div>
    <div id="environment-info"></div>
    <div id="surplus-info"></div>
    <div id="disaster-alert" class="disaster-alert hidden"></div>
    <div id="investments-list"></div>
    <div id="irrigation-negotiate-section" class="hidden"></div>
    <div id="markets-info"></div>
    <div id="player-info"></div>
    <div id="promises-info"></div>
  </div>

  <!-- Tab: Villages -->
  <div id="tab-villages" class="tab-content hidden">
    <table id="village-table" class="data-table">
      <thead>
        <tr>
          <th>村庄</th>
          <th>人口</th>
          <th>承载上限</th>
          <th>耕地(亩)</th>
          <th>地主占比</th>
          <th>民心</th>
          <th>治安</th>
          <th>村塾</th>
          <th>地主</th>
          <th>村民代表</th>
        </tr>
      </thead>
      <tbody id="village-tbody"></tbody>
    </table>

    <!-- Village detail modal -->
    <div id="village-detail-modal" class="modal hidden">
      <div class="modal-content village-detail-content">
        <div class="village-detail-header">
          <h4 id="village-detail-title">村庄详情</h4>
          <button id="village-detail-close" class="btn btn-small">关闭</button>
        </div>
        <div id="village-detail-body" class="village-detail-body"></div>
      </div>
    </div>
  </div>

  <!-- Tab: Actions -->
  <div id="tab-actions" class="tab-content hidden">
    <div class="action-section">
      <h3>税率调整</h3>
      <div class="tax-control">
        <input type="range" id="tax-slider" min="9" max="15" step="1" value="12">
        <span id="tax-display">12%</span>
        <button id="btn-set-tax" class="btn btn-primary btn-small">确认调整</button>
      </div>
    </div>

    <div class="action-section">
      <h3>商税税率</h3>
      <div class="tax-control">
        <input type="range" id="commercial-tax-slider" min="1" max="5" step="0.5" value="3">
        <span id="commercial-tax-display">3%</span>
        <button id="btn-set-commercial-tax" class="btn btn-primary btn-small">确认调整</button>
      </div>
    </div>

    <div class="action-section">
      <h3>投资施政</h3>
      <div id="invest-cards" class="invest-grid"></div>
    </div>

    <!-- Village target modal -->
    <div id="village-modal" class="modal hidden">
      <div class="modal-content">
        <h4 id="modal-title">选择目标村庄</h4>
        <select id="modal-village-select"></select>
        <div class="modal-actions">
          <button id="modal-confirm" class="btn btn-primary btn-small">确认</button>
          <button id="modal-cancel" class="btn btn-small">取消</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab: Relationships (人脉) -->
  <div id="tab-relationships" class="tab-content hidden">
    <div id="relationships-list">
      <p class="hint">加载中...</p>
    </div>
  </div>

  <!-- Tab: Staff (幕僚) -->
  <div id="tab-staff" class="tab-content hidden">
    <div id="staff-content">
      <p class="hint">加载中...</p>
    </div>
  </div>

  <!-- Tab: Neighbors (邻县) -->
  <div id="tab-neighbors" class="tab-content hidden">
    <div id="neighbors-list">
      <p class="hint">加载中...</p>
    </div>
  </div>

  <!-- Tab: Events (县志) -->
  <div id="tab-events" class="tab-content hidden">
    <div class="events-controls">
      <select id="events-category-filter">
        <option value="">全部分类</option>
        <option value="INVESTMENT">投资</option>
        <option value="TAX">税率</option>
        <option value="NEGOTIATION">谈判</option>
        <option value="DISASTER">灾害</option>
        <option value="SETTLEMENT">结算</option>
        <option value="ANNEXATION">兼并</option>
        <option value="PROMISE">承诺</option>
        <option value="SYSTEM">系统</option>
      </select>
      <button id="btn-refresh-events" class="btn btn-small">刷新</button>
    </div>
    <div id="events-list"></div>
  </div>

  <!-- Tab: Report -->
  <div id="tab-report" class="tab-content hidden">
    <div id="report-content">
      <p class="hint">推进月份后将在此显示月报</p>
    </div>
    <button id="btn-advance" class="btn btn-primary btn-advance">推进月份</button>
    <div id="neighbor-precompute-status" class="precompute-status"></div>
  </div>
</section>

<!-- ==================== Screen 4: End Summary ==================== -->
<section id="screen-summary" class="screen hidden">
  <div class="summary-box">
    <div id="summary-v2"></div>
    <div id="summary-stats" class="hidden"></div>
    <div id="summary-villages" class="hidden"></div>
    <button id="btn-back-from-summary" class="btn btn-primary">返回游戏列表</button>
  </div>
</section>

<!-- ==================== Negotiation Chat Modal ==================== -->
<div id="negotiation-modal" class="modal hidden">
  <div class="modal-content nego-modal-content">
    <div class="nego-header">
      <div>
        <h4 id="nego-title">谈判</h4>
        <span id="nego-subtitle" class="nego-subtitle"></span>
      </div>
      <button id="nego-close" class="btn btn-small">关闭</button>
    </div>
    <div id="nego-messages" class="nego-messages"></div>
    <div id="nego-resolved" class="nego-resolved hidden"></div>
    <div id="nego-input-area" class="nego-input-area">
      <select id="nego-speaker" class="nego-speaker">
        <option value="PLAYER">县令亲谈</option>
        <option value="ADVISOR">委托师爷</option>
        <option value="DEPUTY">委托县丞</option>
      </select>
      <input type="text" id="nego-input" class="nego-input" placeholder="输入你的话..." maxlength="500">
      <button id="nego-send" class="btn btn-primary btn-small">发言</button>
    </div>
  </div>
</div>

<!-- ==================== Agent Profile Modal ==================== -->
<div id="agent-profile-modal" class="modal hidden">
  <div class="modal-content agent-profile-content">
    <div class="agent-profile-header">
      <h4>人物档案</h4>
      <button id="agent-profile-close" class="btn btn-small">关闭</button>
    </div>
    <div id="agent-profile-body" class="agent-profile-body"></div>
  </div>
</div>

<!-- ==================== Staff Chat Modal ==================== -->
<div id="staff-chat-modal" class="modal hidden">
  <div class="modal-content nego-modal-content">
    <div class="nego-header">
      <div>
        <h4 id="staff-chat-title">对话</h4>
        <span id="staff-chat-subtitle" class="nego-subtitle"></span>
      </div>
      <button id="staff-chat-close" class="btn btn-small">关闭</button>
    </div>
    <div id="staff-chat-messages" class="nego-messages"></div>
    <div id="staff-chat-input-area" class="nego-input-area">
      <input type="text" id="staff-chat-input" class="nego-input" placeholder="输入你的话..." maxlength="500">
      <button id="staff-chat-send" class="btn btn-primary btn-small">发言</button>
    </div>
  </div>
</div>

<!-- ==================== Neighbor Detail Modal ==================== -->
<div id="neighbor-detail-modal" class="modal hidden">
  <div class="modal-content neighbor-detail-content">
    <div class="neighbor-detail-header">
      <h4 id="neighbor-detail-title">邻县详情</h4>
      <button id="neighbor-detail-close" class="btn btn-small">关闭</button>
    </div>
    <div id="neighbor-detail-body" class="neighbor-detail-body"></div>
  </div>
</div>

<!-- ==================== Advisor Warning Modal (过度开发) ==================== -->
<div id="advisor-warning-modal" class="modal hidden">
  <div class="modal-content modal-sm">
    <h3 style="margin-top:0;color:#8b4513;">顾问谏言</h3>
    <p id="advisor-warning-text" style="line-height:1.6;"></p>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px;">
      <button id="advisor-warning-cancel" class="btn btn-small">等待勘查</button>
      <button id="advisor-warning-proceed" class="btn btn-small btn-primary">立即开垦</button>
    </div>
  </div>
</div>

<!-- ==================== Toast Container ==================== -->
<div id="toast-container"></div>

<!-- Scripts -->
<script src="{% static 'game/js/api.js' %}"></script>
<script src="{% static 'game/js/state.js' %}"></script>
<script src="{% static 'game/js/components-core.js' %}"></script>
<script src="{% static 'game/js/components-county.js' %}"></script>
<script src="{% static 'game/js/components-social.js' %}"></script>
<script src="{% static 'game/js/components-neighbors.js' %}"></script>
<script src="{% static 'game/js/screens.js' %}"></script>
<script src="{% static 'game/js/app.js' %}"></script>

</body>
</html>
