# 01 — AI Agent 系统设计

> v0.2 更新：对齐构思文档的三层属性体系、政治理念维度

---

## 1. 设计目标
- 让NPC具备自主目标和个性化决策能力，而非脚本驱动
- 控制LLM调用成本，核心角色用LLM，外围角色用规则引擎
- Agent行为对玩家而言"可感知但不透明"——能观察到行为模式，但猜不透全部动机

---

## 2. Agent 分层架构

### 2.1 完整Agent（LLM驱动）
- **适用角色**：与玩家直接交互的NPC（知府、考核官、关键地主、师爷）
- **能力**：自然语言对话、基于人设的自主决策、记忆和态度演变
- **调用时机**：对话事件、考核投票、重大事件决策
- **MVP数量**：约8-12个

### 2.2 轻量Agent（规则引擎 + LLM模板）
- **适用角色**：有一定互动但不频繁的NPC（邻县县令、普通村民代表、商户）
- **能力**：基于规则表的决策 + 必要时调用LLM生成对话文本
- **调用时机**：仅在被玩家主动交互时触发LLM，日常行为用规则
- **MVP数量**：约10-15个

### 2.3 背景Agent（纯数值）
- **适用角色**：不直接出场的远程官员、其他县的经济体
- **能力**：按预设规则更新数值状态
- **不调用LLM**

---

## 3. Agent 属性体系（三层结构）

### 3.1 核心属性（公开可推测）
| 属性 | 取值 | 影响 |
|------|------|------|
| 智力 | 1-10 | 决策质量、识破谎言概率、处理复杂事务的能力 |
| 体魄 | 1-10 | 任职年限上限、应对突发事件的执行力、抗压能力 |

> 玩家角色不显示这两项数值，靠行为表现被系统后台评估。Agent的核心属性对玩家也不直接展示，但可通过交互和传闻间接推测（如"此人精明强干"暗示智力高）。

### 3.2 性格属性（隐藏）
五维，各0.0-1.0（0.5为中点）：

| 属性 | 低值倾向（<0.3） | 高值倾向（>0.7） |
|------|-----------------|-----------------|
| 合群—孤僻 | 善于社交、爱参加聚会、易受舆论影响 | 独来独往、不在乎评价、难以拉拢 |
| 理性—感性 | 数据驱动、冷静算计、不容易被感动 | 凭直觉和情感决策、容易被感动或激怒 |
| 沉默—张扬 | 低调行事、暗中布局、不轻易表态 | 高调表态、喜欢造势、爱出风头 |

### 3.3 政治理念（隐藏）
三维，各0.0-1.0：

| 维度 | 低值倾向（<0.3） | 高值倾向（>0.7） | 影响 |
|------|-----------------|-----------------|------|
| 社稷—黎民 | 优先国家利益和君主意志 | 优先百姓福祉 | 影响税收执行、赈灾态度、政策倾向 |
| 集权—分权 | 支持君主集权、强化中央 | 支持相权、六部分权 | 影响对中央政策的态度、派系选择 |
| 现实—理想 | 务实灵活、接受妥协 | 坚守原则、不惜代价 | 影响面对灰色问题时的选择 |

### 3.4 名誉属性（半隐藏）
三维，各0-100：

| 维度 | 增减来源 | 展示方式 |
|------|---------|---------|
| 清名 | 公正执法↑、贪腐↓ | 对外显示5档粗略分级 |
| 能名 | 政绩突出↑、施政失误↓ | 分级与实际值有±10的偏差 |
| 人缘 | 社交活跃↑、弹劾他人↓ | 偏差使玩家不能精确判断 |
| 诚信 | 履行承诺↑、失信, 谎言↓ | 对外显示5档粗略分级 |


> **偏差设计**：5档分级为 极低(0-20) / 低(21-40) / 中(41-60) / 高(61-80) / 极高(81-100)，但展示时有随机偏差，比如实际45可能显示为"低"或"中"。偏差范围±10。

### 3.5 目标体系（权重总和=1.0）
```json
{
  "goals": {
    "welfare": 0.25,    // 造福百姓（管辖地区幸福指数提升）
    "reputation": 0.20, // 名誉声望（施政成绩 + 官员间互相认可）
    "power": 0.30,      // 权力升迁（做更大的官）
    "wealth": 0.15,     // 享受生活（更多钱或等价物）
    "legacy": 0.10      // 传承（后代得到升迁）
  }
}
```

### 3.6 关系网络
```json
{
  "relationships": {
    "agent_002": {
      "affinity": 35,
      "tags": ["同乡", "上级"],
      "debts": [],                    // 人情债
      "history": ["考核中支持过我"]
    },
    "agent_005": {
      "affinity": -10,
      "tags": ["政敌"],
      "debts": [],
      "history": ["弹劾过我的恩师"]
    }
  }
}
```

### 3.7 记忆系统
- **短期记忆**：当前年度内的交互事件（每年清理，保留摘要）
- **长期记忆**：关键事件摘要（如"玩家曾在灾年拒绝我的减税请求"）
- **记忆格式**：`{时间, 事件摘要, 情感标签, 涉及对象}`
- **上下文窗口管理**：每次LLM调用时，从记忆库中检索最相关的5-8条记忆注入prompt

---

## 4. 派系归属计算

### 4.1 派系形成规则
- **初始设置**：开局手动设定中央顶层派系（2-3个），基于政治理念和个人关系
- **动态形成**（后续版本）：如果一个不属于任何派系的内阁成员，且朝中与其政治理念相同、且不属于任何派系的官员比例超过阈值 → 形成新派系

### 4.2 政治理念匹配
两个Agent"政治理念相同"的定义：
- 三个维度都在同一区间（均>0.5 或均<0.5）
- 且至少有一个维度都>0.7 或都<0.3

### 4.3 派系影响
- 同派系成员之间好感度+15
- 对立派系之间好感度-10
- 派系与皇帝之间有独立的好感度值
- 派系好感度影响该派系成员的考核权重

---

## 5. Agent 决策流程

### 5.1 完整Agent的决策流程
```
触发决策需求
    ↓
组装上下文（角色设定 + 三层属性 + 目标权重 + 当前状态 + 相关记忆 + 关系 + 人情债）
    ↓
调用LLM，生成决策/对话
    ↓
解析LLM输出（结构化：行动选择 + 态度变化 + 对外表达）
    ↓
执行决策 → 更新世界状态 → 写入记忆
```

### 5.2 轻量Agent的决策流程
```
触发决策需求
    ↓
查规则表（基于属性和目标权重的加权评分）
    ↓
若需要对话文本 → 调用LLM生成（一次性，短prompt）
    ↓
执行决策 → 更新数值
```

### 5.3 LLM Prompt 结构（完整Agent）
```
[System]
你是{角色名}，{角色简介}。

## 你的属性
核心能力：智力{X}/10，体魄{Y}/10
性格：{性格属性的自然语言描述，如"你性格圆滑合群，行事低调务实"}
政治理念：{理念描述，如"你信奉国家利益至上，支持中央集权，行事务实灵活"}

## 你的目标（按优先级）
{目标列表及权重描述}

## 你的处境
职位：{职位}，辖区状态：{关键指标}
面临的压力：{如上级考核压力、派系斗争等}

## 你的关系
与{相关人物}的关系：{好感度区间 + 关系标签 + 人情债}
你记得的重要事件：{记忆摘要}

[User]
当前情境：{事件描述}
你的可选行动：{行动列表}

请做出决策。输出JSON格式：
{
  "decision": "选择的行动",
  "reasoning": "内心考量（不超过100字）",
  "attitude_changes": {"agent_id": 变化量},
  "dialogue": "对外说的话（如有）",
  "new_memory": "需要记住的要点"
}
```

---

## 6. 关键场景的Agent行为设计

### 6.1 知府（玩家直属上级）
- **日常行为**：每年分配税收指标、传达中央政策、不定期巡视
- **关键决策点**：是否支持玩家减税申请、考核时如何评价、是否包庇或打压
- **行为逻辑**：综合考虑自身考核压力、与玩家好感度、玩家辖区政绩、派系关系
- **人情债场景**：如果玩家曾帮助知府完成某项指标，知府可能在考核中"还人情"

### 6.2 地主士绅
- **日常行为**：尝试扩大土地、减少自身税负、维护地方影响力
- **关键决策点**：是否配合赈灾、是否在背后告状、是否行贿、是否发动官场关系
- **行为逻辑**：自身利益优先，但受性格和政治理念影响（开明士绅可能配合公益）
- **官场关联**：每个地主有明确的"背景标签"（无/府级/省级/中央级），影响其施压能力

### 6.3 师爷（幕僚）
- **定位**：游戏助理 + 新人引导 + 策略顾问
- **日常行为**：每季度可免费问询1次，获取局面分析和行动建议
- **行为逻辑**：基于自身专长给建议，但建议带有师爷自己的性格偏见
- **忠诚度**：长期违背师爷建议可能降低其忠诚度，极端情况下师爷辞职

### 6.4 考核委员
- **出场时机**：年终考核
- **决策逻辑**：基于政绩数据 × 个人政治理念偏好 × 收到的举荐/弹劾信息 × 与玩家的关系
- **投票机制**：每位委员给出 升/留/降 的投票 + 理由

---

## 7. 成本与性能控制

### 7.1 LLM调用预算（MVP单局估算）
- 完整Agent对话事件：约 20-30 次（每次审案/谈判约3-5轮）
- Agent自主决策：约 15-20 次（每季度2-3个Agent决策）
- 年终考核：约 5-8 次（委员投票 + 面谈）
- **单局总计：约 50-70 次 LLM 调用**

### 7.2 优化策略
- 轻量Agent尽量用规则引擎，仅对话时调LLM
- Agent决策可批量处理（同一回合的多个Agent决策合并为一次调用）
- 对话历史做摘要压缩，控制context长度
- 缓存常见场景的Agent反应模板

---

## 8. MVP阶段Agent清单

| 角色 | 数量 | 层级 | 说明 |
|------|------|------|------|
| 知府 | 1 | 完整 | 玩家直属上级，最重要的博弈对象 |
| 邻县县令 | 2 | 轻量 | 社交、对比、偶尔互动 |
| 地主士绅 | 3 | 完整2+轻量1 | 县域内核心博弈对象 |
| 村民代表 | 3 | 轻量 | 审案、征税场景中出场 |
| 商户代表 | 1 | 轻量 | 商业政策相关 |
| 师爷 | 1 | 完整 | 玩家顾问，游戏助理，新人引导 |
| 考核委员 | 3 | 完整 | 年终考核出场 |
| 京官/省官来访 | 1 | 完整 | 随机事件触发 |
| **合计** | **15** | | |
